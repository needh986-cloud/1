import{serve}from"https://deno.land/std@0.192.0/http/server.ts";serve(async(r)=>{if(r.method==="OPTIONS")return new Response("ok",{headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"authorization, x-client-info, apikey, content-type"}});try{const{email,verificationCode,fullName}=await r.json();if(!email||!verificationCode)return new Response(JSON.stringify({error:"Missing fields"}),{status:400,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}});const k=Deno.env.get('RESEND_API_KEY');if(!k)throw new Error('No API key');const res=await fetch('https://api.resend.com/emails',{method:'POST',headers:{'Authorization':'Bearer '+k,'Content-Type':'application/json'},body:JSON.stringify({from:"onboarding@resend.dev",to:[email],subject:"Email Verification - PromoHive",html:'<div style="font-family:Arial;max-width:600px;margin:0 auto;padding:20px"><div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;text-align:center;border-radius:12px 12px 0 0"><h1 style="margin:0;font-size:28px">PromoHive</h1><p style="margin:10px 0 0">Hello '+(fullName||'User')+'</p></div><div style="background:white;padding:40px 30px;text-align:center;border:1px solid #e0e0e0;border-top:none"><h2 style="color:#333;margin:0 0 20px">Email Verification</h2><p style="color:#666;margin:0 0 30px">Thank you for registering. Use the code below:</p><div style="background:#f1f3f4;border:2px dashed #667eea;border-radius:8px;padding:20px;margin:30px 0"><div style="font-size:32px;font-weight:bold;color:#667eea;letter-spacing:4px;font-family:monospace">'+verificationCode+'</div></div><p style="color:#999;font-size:14px">Valid for 10 minutes</p></div><div style="background:#f8f9fa;padding:20px;text-align:center;color:#6c757d;font-size:12px;border-radius:0 0 12px 12px"><p style="margin:0">© 2022 PromoHive</p></div></div>',text:'PromoHive - Verification Code: '+verificationCode+'\n\nValid for 10 minutes.\n\n© 2022 PromoHive'})});if(!res.ok)throw new Error('Resend error');const d=await res.json();return new Response(JSON.stringify({success:true,message:"Code sent",emailId:d.id}),{status:200,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}catch(e){return new Response(JSON.stringify({error:"Failed to send code",details:e.message}),{status:500,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}})}});
