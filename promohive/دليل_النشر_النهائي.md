# 🚀 دليل النشر النهائي - PromoHive

## 📋 جدول المحتويات
1. [التحقق من الاستعداد](#1-التحقق-من-الاستعداد)
2. [نشر قاعدة البيانات](#2-نشر-قاعدة-البيانات)
3. [تكوين SMTP](#3-تكوين-smtp)
4. [نشر Edge Functions](#4-نشر-edge-functions)
5. [نشر التطبيق على Netlify](#5-نشر-التطبيق-على-netlify)
6. [الاختبار النهائي](#6-الاختبار-النهائي)
7. [إنشاء حساب الأدمن](#7-إنشاء-حساب-الأدمن)

---

## 1️⃣ التحقق من الاستعداد

### ✅ تأكد من أن لديك:
- [ ] حساب Supabase نشط
- [ ] مشروع Supabase: `jtxmijnxrgcwjvtdlgxy`
- [ ] حساب Netlify
- [ ] مستودع GitHub متصل
- [ ] بيانات SMTP من Hostinger

### 📊 تحقق من قاعدة البيانات:

افتح Supabase SQL Editor ونفذ:

```sql
-- يجب أن ترى: 7 جداول، 24 إعدادات، 8 محافظ، 5 وظائف
SELECT 
    (SELECT COUNT(*) FROM information_schema.tables 
     WHERE table_schema = 'public' 
     AND table_name IN ('wallets', 'admin_settings', 'referrals', 
                        'spin_prizes', 'level_upgrades', 'usdt_addresses', 'admin_actions')) 
    as tables,
    (SELECT COUNT(*) FROM admin_settings) as settings,
    (SELECT COUNT(*) FROM wallets) as wallets,
    (SELECT COUNT(*) FROM information_schema.routines 
     WHERE routine_schema = 'public' 
     AND routine_name IN ('get_setting', 'can_spin_today', 'process_spin', 
                          'check_referral_rewards', 'request_level_upgrade')) 
    as functions;
```

**النتيجة المتوقعة:**
```
tables: 7
settings: 24
wallets: 8
functions: 5
```

✅ إذا رأيت هذه الأرقام، قاعدة البيانات جاهزة!

---

## 2️⃣ نشر قاعدة البيانات

### ✅ الجداول موجودة بالفعل!

إذا كانت الأرقام أعلاه صحيحة، فأنت **لا تحتاج لفعل شيء**!

### 🔧 إذا احتجت إعادة التنفيذ:

1. افتح: https://supabase.com/dashboard/project/jtxmijnxrgcwjvtdlgxy/sql
2. اضغط "New Query"
3. نفذ الملفات بالترتيب:
   - ملف 1: `supabase/migrations/20241031_fix_email_confirmation_and_wallet.sql`
   - ملف 2: الكود الذي نفذته سابقاً

---

## 3️⃣ تكوين SMTP

### 📧 إضافة Secrets في Supabase:

1. **افتح:** https://supabase.com/dashboard/project/jtxmijnxrgcwjvtdlgxy/settings/functions

2. **انقر على "Secrets"**

3. **أضف كل واحدة من هذه:**

```
Name: SMTP_HOST
Value: smtp.hostinger.com
[Save]

Name: SMTP_PORT
Value: 465
[Save]

Name: SMTP_USER
Value: promohive@globalpromonetwork.store
[Save]

Name: SMTP_PASS
Value: PromoHive@2025!
[Save]

Name: SMTP_FROM
Value: promohive@globalpromonetwork.store
[Save]
```

### ✅ التحقق:
- يجب أن ترى 5 secrets في القائمة
- كل secret له أيقونة قفل 🔒

---

## 4️⃣ نشر Edge Functions

### 📤 نشر وظيفة البريد الإلكتروني:

#### الطريقة 1: عبر Dashboard (الأسهل):

1. **افتح:** https://supabase.com/dashboard/project/jtxmijnxrgcwjvtdlgxy/functions

2. **ابحث عن `send-notification-email`**
   - إذا وجدتها → اضغط عليها → اضغط "Deploy"
   - إذا لم تجدها → اضغط "Create Function"

3. **إذا كنت تنشئها جديداً:**
   - Name: `send-notification-email`
   - انسخ محتوى: `supabase/functions/send-notification-email/index.ts`
   - الصق في الـ editor
   - اضغط "Deploy"

#### الطريقة 2: عبر CLI (إذا كان مُثبت):

```bash
cd /workspace/promohive
supabase functions deploy send-notification-email
```

### ✅ التحقق:
- يجب أن ترى الـ function في القائمة
- Status: "Active" 🟢

---

## 5️⃣ نشر التطبيق على Netlify

### 🌐 الخطوات:

#### A. إعدادات البيئة في Netlify:

1. **افتح:** https://app.netlify.com (وسجل دخول)

2. **اختر موقعك** (أو أنشئ موقع جديد من GitHub)

3. **اذهب إلى:** Site settings → Environment variables

4. **أضف هذه المتغيرات:**

```
VITE_SUPABASE_URL
Value: https://jtxmijnxrgcwjvtdlgxy.supabase.co

VITE_SUPABASE_ANON_KEY
Value: [احصل عليه من Supabase → Settings → API → anon public]
```

**للحصول على `VITE_SUPABASE_ANON_KEY`:**
1. افتح: https://supabase.com/dashboard/project/jtxmijnxrgcwjvtdlgxy/settings/api
2. انسخ `anon` `public` key
3. الصقه في Netlify

#### B. إعدادات Build:

في Netlify → Site settings → Build & deploy:

```
Build command: npm run build
Publish directory: dist
Node version: 18
```

#### C. تفعيل النشر التلقائي:

1. **اذهب إلى:** Deploys → Deploy settings
2. **تأكد من تفعيل:** "Auto publishing"
3. **Branch:** `main`

### 🚀 نشر يدوي (الآن):

1. **اذهب إلى:** Deploys
2. **اضغط:** "Trigger deploy" → "Deploy site"
3. **انتظر** (~2-3 دقائق)
4. **عند النجاح** ستحصل على رابط مثل: `https://your-site.netlify.app`

### ✅ التحقق:
- ✅ Build successful (أخضر)
- ✅ Published
- ✅ الموقع يفتح بدون أخطاء

---

## 6️⃣ الاختبار النهائي

### 🧪 اختبر هذه الوظائف:

#### 1. تسجيل مستخدم جديد:
```
1. اذهب إلى موقعك/register
2. سجل مستخدم جديد
3. تحقق: يجب أن تُنشأ محفظة تلقائياً
```

**في SQL Editor:**
```sql
SELECT * FROM wallets ORDER BY created_at DESC LIMIT 1;
-- يجب أن ترى المحفظة الجديدة
```

#### 2. موافقة الأدمن:
```
1. سجل دخول كأدمن
2. اذهب إلى /admin-dashboard
3. افتح تبويب "Users"
4. اضغط "Approve" على المستخدم الجديد
5. تحقق: يجب أن يحصل على $5 ترحيب
```

**في SQL Editor:**
```sql
SELECT available_balance, earnings_from_bonuses 
FROM wallets 
WHERE user_id = 'USER_ID_HERE';
-- يجب أن ترى: available_balance = 5, earnings_from_bonuses = 5
```

#### 3. البريد الإلكتروني:
```
1. بعد الموافقة
2. تحقق من البريد الإلكتروني للمستخدم
3. يجب أن تصل رسالة من: promohive@globalpromonetwork.store
4. العنوان: "Welcome to PromoHive! 🎉"
5. المحتوى: يحتوي على "$5 bonus"
```

#### 4. عجلة الحظ:
```
1. سجل دخول كمستخدم عادي
2. اذهب إلى /daily-spin-wheel
3. اضغط "Spin"
4. يجب أن تربح بين $0.05 و $0.30
5. تحقق من زيادة الرصيد
```

#### 5. نظام الإحالات:
```
1. اذهب إلى /referrals-management
2. انسخ كود الإحالة
3. سجل خروج
4. سجل مستخدم جديد بكود الإحالة
5. تحقق من تسجيل الإحالة في قاعدة البيانات
```

**في SQL Editor:**
```sql
SELECT * FROM referrals ORDER BY created_at DESC LIMIT 1;
-- يجب أن ترى الإحالة الجديدة
```

#### 6. صفحة الأدمن:
```
1. سجل دخول كأدمن
2. يجب أن ترى زر "Admin Dashboard" في:
   - الهيدر (Desktop)
   - القائمة الجانبية (Mobile)
   - زر عائم في Dashboard
3. اضغط على أي منها
4. يجب أن تفتح /admin-dashboard بدون أخطاء
```

---

## 7️⃣ إنشاء حساب الأدمن

### 🔐 طريقة 1: عبر SQL (الأسهل):

```sql
-- 1. سجل مستخدم عادي من الموقع أولاً

-- 2. ثم نفذ هذا لتحويله لأدمن (غير EMAIL_HERE ببريدك)
UPDATE auth.users
SET raw_user_meta_data = raw_user_meta_data || '{"role": "admin"}'::jsonb
WHERE email = 'EMAIL_HERE@example.com';

-- 3. تحقق
SELECT email, raw_user_meta_data->>'role' as role
FROM auth.users
WHERE email = 'EMAIL_HERE@example.com';
-- يجب أن ترى: role = admin
```

### 🔐 طريقة 2: إنشاء Super Admin:

```sql
-- 1. أنشئ المستخدم مباشرة
INSERT INTO auth.users (
    instance_id,
    id,
    aud,
    role,
    email,
    encrypted_password,
    email_confirmed_at,
    raw_user_meta_data,
    created_at,
    updated_at
) VALUES (
    '00000000-0000-0000-0000-000000000000',
    gen_random_uuid(),
    'authenticated',
    'authenticated',
    'admin@promohive.com',
    crypt('AdminPassword123!', gen_salt('bf')),
    NOW(),
    '{"role": "super_admin"}'::jsonb,
    NOW(),
    NOW()
) RETURNING id;

-- 2. أنشئ ملف تعريف
INSERT INTO user_profiles (
    id,
    email,
    username,
    full_name,
    role,
    approval_status,
    status
) VALUES (
    (SELECT id FROM auth.users WHERE email = 'admin@promohive.com'),
    'admin@promohive.com',
    'admin',
    'Super Administrator',
    'super_admin',
    'approved',
    'active'
);
```

**بيانات الدخول:**
```
Email: admin@promohive.com
Password: AdminPassword123!
```

⚠️ **مهم:** غير كلمة المرور فوراً بعد أول تسجيل دخول!

---

## 🎯 قائمة التحقق النهائية

قبل إطلاق الموقع للجمهور، تأكد من:

### قاعدة البيانات:
- [ ] 7 جداول موجودة
- [ ] 24 إعداد موجود
- [ ] جميع الوظائف (8) تعمل
- [ ] RLS Policies مُفعلة

### SMTP:
- [ ] جميع الـ 5 secrets موجودة
- [ ] Edge Function منشورة
- [ ] البريد يصل للمستخدمين الجدد

### Netlify:
- [ ] متغيرات البيئة مُضافة
- [ ] Build ناجح
- [ ] الموقع يعمل بدون أخطاء Console

### الوظائف:
- [ ] تسجيل المستخدمين يعمل
- [ ] إنشاء المحافظ تلقائي
- [ ] موافقة الأدمن تُضيف $5
- [ ] عجلة الحظ تعمل
- [ ] نظام الإحالات يُسجل
- [ ] لوحة الأدمن تظهر للأدمن فقط

### الأمان:
- [ ] لا أحد يستطيع الوصول لـ /admin-dashboard بدون دور admin
- [ ] المستخدمون يرون محافظهم فقط
- [ ] جميع العمليات المالية مُسجلة

---

## 🐛 حل المشاكل الشائعة

### مشكلة: "Cannot connect to database"
**الحل:**
```
1. تحقق من أن مشروع Supabase لم يتم إيقافه
2. تحقق من VITE_SUPABASE_URL صحيح
3. تحقق من VITE_SUPABASE_ANON_KEY صحيح
```

### مشكلة: "Email not sending"
**الحل:**
```
1. تحقق من SMTP secrets موجودة
2. تحقق من Edge Function منشورة
3. تحقق من Logs في Supabase Functions
```

### مشكلة: "Admin Dashboard not showing"
**الحل:**
```sql
-- تحقق من دور المستخدم
SELECT email, raw_user_meta_data->>'role' 
FROM auth.users 
WHERE email = 'YOUR_EMAIL';

-- يجب أن يكون: admin أو super_admin
```

### مشكلة: "Wallet not created"
**الحل:**
```sql
-- أنشئ المحفظة يدوياً
SELECT create_user_wallet('USER_ID_HERE');
```

---

## 📞 الدعم والمساعدة

### 📚 الملفات المرجعية:
- `اجابات_كاملة_على_اسئلتك.md` - دليل شامل
- `WHERE_ARE_THE_FILES_AR.md` - مواقع جميع الملفات
- `START_HERE_QUICK_GUIDE.md` - دليل البداية السريع

### 🔍 فحص الأخطاء:

```sql
-- 1. عرض آخر 10 معاملات
SELECT * FROM transactions ORDER BY created_at DESC LIMIT 10;

-- 2. عرض آخر إجراءات الأدمن
SELECT * FROM admin_actions ORDER BY created_at DESC LIMIT 10;

-- 3. عرض المستخدمين المعلقين
SELECT email, username, created_at 
FROM user_profiles 
WHERE approval_status = 'pending';

-- 4. عرض جميع الإعدادات
SELECT * FROM admin_settings ORDER BY category, key;
```

---

## 🎊 مبروك! موقعك جاهز للإطلاق!

### ✅ ما لديك الآن:

**نظام كامل ومتكامل:**
- ✅ محافظ فردية لكل مستخدم
- ✅ نظام موافقات الأدمن
- ✅ مكافأة ترحيب $5 تلقائية
- ✅ عجلة حظ يومية
- ✅ نظام إحالات مع مكافآت
- ✅ ترقية مستويات مدفوعة
- ✅ سحب أموال (حد أدنى $10)
- ✅ لوحة تحكم أدمن كاملة
- ✅ تسجيل شامل لكل الإجراءات
- ✅ إشعارات بريد إلكتروني تلقائية

**كل شيء محمي وآمن:**
- ✅ RLS على جميع الجداول
- ✅ التحقق من الأدوار
- ✅ تسجيل جميع الإجراءات
- ✅ المنطق السري على السيرفر

**جاهز للنشر:**
- ✅ قاعدة بيانات كاملة
- ✅ واجهة مستخدم جميلة
- ✅ نشر تلقائي مع كل تحديث
- ✅ خالي من الأخطاء

---

## 🚀 ابدأ الآن!

رابط موقعك على Netlify:
```
https://your-site-name.netlify.app
```

**استمتع بموقعك! 🎉**

---

**تاريخ آخر تحديث:** 2025-10-31  
**الإصدار:** 1.0.0 - Production Ready  
**الحالة:** ✅ جاهز للإطلاق
