═══════════════════════════════════════════════════════════════════════
🎯 نسخ ولصق سريع - إصلاح قاعدة البيانات
═══════════════════════════════════════════════════════════════════════

📍 الخطوة 1: افتح هذا الرابط
───────────────────────────────────────────────────────────────────────
https://supabase.com/dashboard/project/jtxmijnxrgcwjvtdlgxy/sql/new
───────────────────────────────────────────────────────────────────────

📝 الخطوة 2: انسخ والصق هذا الكود ثم اضغط RUN
───────────────────────────────────────────────────────────────────────

CREATE OR REPLACE FUNCTION public.handle_new_user_with_verification()
RETURNS TRIGGER
SECURITY DEFINER
LANGUAGE plpgsql
AS $$
DECLARE
    referral_code_text TEXT;
BEGIN
    referral_code_text := UPPER(SUBSTRING(NEW.id::TEXT FROM 1 FOR 8));
    
    INSERT INTO public.user_profiles (
        id, email, full_name, role, status, 
        approval_status, email_verified, referral_code, 
        level, welcome_bonus_used
    )
    VALUES (
        NEW.id, NEW.email, 
        COALESCE(NEW.raw_user_meta_data->>'full_name', split_part(NEW.email, '@', 1)),
        COALESCE(NEW.raw_user_meta_data->>'role', 'user')::user_role,
        'pending'::user_status, 'pending', false, 
        referral_code_text, 0, false
    );
    
    RETURN NEW;
END;
$$;

───────────────────────────────────────────────────────────────────────

✅ النتيجة: سترى "Success. No rows returned"

🎉 تم! الخطأ محلول. جرب التسجيل الآن في تطبيقك.

═══════════════════════════════════════════════════════════════════════
